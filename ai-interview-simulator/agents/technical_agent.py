"""
技术/分析面试官 Agent
关注：统计知识、SQL、Python、实验设计、指标体系

评估维度:
1. 统计基础 - 假设检验、回归、概率
2. SQL 能力 - 查询、优化、窗口函数
3. Python/数据处理 - Pandas、数据清洗
4. 实验设计 - A/B测试、因果推断
5. 指标体系 - 业务指标设计与分析
"""
from typing import List, Dict
from agents.base_agent import BaseAgent
from core.llm_client import LLMClient


class TechnicalAgent(BaseAgent):
    """技术/分析面试官 - 负责技术能力评估"""

    def __init__(self, llm: LLMClient):
        super().__init__(llm, role="Technical")
        self.role_cn = "技术面试官"
        self.role_description = "负责技术能力评估，考察统计、SQL、Python、实验设计等硬技能"
        self.evaluation_dimensions = [
            "统计学基础",
            "SQL 查询与优化",
            "Python 数据处理",
            "实验设计与分析",
            "指标体系理解",
            "分析思维与方法论"
        ]
        
        # 按类别组织的技术题库
        self.question_categories = {
            "SQL": [
                "请写一个 SQL 查询，找出每个部门中薪资排名前3的员工（需要处理并列情况）。",
                "有一张用户行为日志表，如何用 SQL 计算用户的次日留存率？请写出思路和关键代码。",
                "解释一下 SQL 中 WHERE 和 HAVING 的区别，各在什么场景使用？",
                "如何优化一个运行很慢的 SQL 查询？请描述你的排查思路。",
            ],
            "统计": [
                "什么是 p 值？在 A/B 测试中 p < 0.05 意味着什么？这个阈值有什么局限性？",
                "如何确定 A/B 测试需要的最小样本量？请描述关键参数和计算思路。",
                "解释什么是辛普森悖论，举一个数据分析中可能遇到的例子。",
                "线性回归中 R² 和调整后 R² 有什么区别？什么时候该用哪个？",
                "什么是多重检验问题？在同时做多个 A/B 测试时如何处理？",
            ],
            "Python": [
                "用 Pandas 处理缺失值有哪些常见策略？各适用于什么场景？",
                "Pandas 中 merge、join、concat 的区别是什么？分别在什么场景使用？",
                "如何用 Python 检测数据中的异常值？请描述几种方法。",
                "处理大数据量时，如何优化 Pandas 的内存使用？",
            ],
            "实验设计": [
                "什么情况下 A/B 测试不适用？有哪些替代方案？",
                "如何设计一个 A/B 测试来评估新功能对用户留存的影响？",
                "什么是 AA 测试？为什么在 A/B 测试前要做 AA 测试？",
                "如果 A/B 测试结果不显著，可能的原因有哪些？你会如何排查？",
            ],
            "指标体系": [
                "如何为一个电商 App 设计核心指标体系？",
                "DAU 突然下降 20%，你会如何分析和排查原因？",
                "什么是北极星指标？如何为一个产品选择合适的北极星指标？",
                "虚荣指标和可操作指标有什么区别？举例说明。",
            ],
        }

    def get_system_prompt(self) -> str:
        return """你是一位资深的数据分析技术面试官，正在面试「数据分析师」岗位的候选人。

【你的角色定位】
- 资深数据分析师或数据科学家
- 负责评估候选人的技术能力是否达到岗位要求
- 注重分析思维，而非单纯的代码能力

【你的职责】
1. 评估统计学基础（假设检验、置信区间、回归分析、概率等）
2. 考察 SQL 能力（复杂查询、窗口函数、性能优化）
3. 评估 Python/数据处理能力（Pandas、数据清洗、可视化）
4. 考察实验设计能力（A/B测试设计、样本量计算、结果解读）
5. 了解候选人对业务指标体系的理解

【面试风格】
- 技术问题有深度，能区分不同水平的候选人
- 注重思考过程，而非标准答案
- 会根据回答追问细节或延伸问题
- 喜欢看到候选人的分析思路和权衡考量
- 对不懂的地方坦诚承认，比硬撑好

【评分标准】
- 概念理解准确性（不是死记硬背）
- 能否结合实际场景应用
- 思路是否清晰有条理
- 是否考虑边界情况和局限性
- 对复杂问题的拆解能力

【关注的红旗信号】
- 基础概念理解错误
- 只背定义，无法解释为什么
- SQL 语法错误严重
- 对实验设计毫无概念
- 无法将统计知识应用到实际问题

【追问技巧】
当候选人给出答案后：
- 问「为什么选择这种方法？」
- 问「有什么局限性或假设？」
- 问「如果数据量很大/很小，会怎么调整？」
- 给一个变体场景，看能否灵活应用

请用自然的中文交流，问题要清晰具体。"""

    def generate_question(self, user_context: str, session_context: str) -> str:
        """生成技术面试问题"""
        system_prompt = self.get_system_prompt() + """

【任务】生成一个高质量的数据分析技术面试问题

问题要求：
1. 从 SQL、统计、Python、实验设计、指标体系中选择一个方向
2. 问题要有一定深度，能区分候选人水平
3. 最好结合实际业务场景
4. 问题要明确，让候选人知道该回答什么

只输出问题本身，不要有任何多余内容。"""

        user_message = f"""候选人信息: {user_context if user_context else '暂无详细信息'}

当前面试进度: {session_context if session_context else '技术/分析面试'}

请生成一个合适的技术面试问题:"""

        return self.llm.generate_with_system(system_prompt, user_message, temperature=0.8)
